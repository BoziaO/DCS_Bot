const {
    EmbedBuilder,
    ActionRowBuilder,
    ButtonBuilder,
    ButtonStyle,
} = require("discord.js");
const LocationManager = require("./locationManager");
const FindManager = require("./findManager");
const EquipmentManager = require("./equipmentManager");
const TeamManager = require("../team/teamManager");
const {parseDuration, formatDuration} = require("../time");

class CooperativeInvestigation {
    constructor() {
        this.locationManager = new LocationManager();
        this.findManager = new FindManager();
        this.equipmentManager = new EquipmentManager();
        this.teamManager = new TeamManager();
        this.cooldownTime = parseDuration("2m");
    }

    async checkTeamCooldown(teamSession) {
        const lastInvestigateTime =
            teamSession.investigationData.lastInvestigate?.getTime() || 0;
        const timeLeft = this.cooldownTime - (Date.now() - lastInvestigateTime);

        if (timeLeft > 0) {
            return {
                onCooldown: true,
                timeLeft: formatDuration(timeLeft),
            };
        }

        return {onCooldown: false};
    }

    checkTeamSanityRequirement(participants, minSanity = 15) {
        const averageSanity =
            participants.reduce((sum, p) => sum + (p.sanity || 50), 0) /
            participants.length;
        return averageSanity >= minSanity;
    }

    createTeamLocationEmbed(location, teamSession) {
        const dangerStars = "‚≠ê".repeat(location.dangerLevel);
        const sizeInfo = location.size ? `\nüìè Rozmiar: ${location.size}` : "";
        const teamSize = teamSession.participants.length;

        return new EmbedBuilder()
            .setTitle("üåô Zespo≈Çowy nocny zwiad")
            .setDescription(
                `Zesp√≥≈Ç dotar≈Ç do lokacji: **${location.name}**\n` +
                `*${location.description}*\n\n` +
                `${location.emoji} Poziom niebezpiecze≈Ñstwa: ${dangerStars}` +
                `${sizeInfo}\n` +
                `üë• Wielko≈õƒá zespo≈Çu: ${teamSize} ${
                    teamSize > 1 ? "cz≈Çonk√≥w" : "cz≈Çonek"
                }\n\n` +
                `**Czy zesp√≥≈Ç chce kontynuowaƒá badanie?**`
            )
            .setColor("#2c3e50")
            .setTimestamp();
    }

    createTeamConfirmationButtons(sessionId) {
        return new ActionRowBuilder().addComponents(
            new ButtonBuilder()
                .setCustomId(`team_investigate_confirm_${sessionId}`)
                .setLabel("Zesp√≥≈Ç wchodzi")
                .setStyle(ButtonStyle.Primary)
                .setEmoji("üö™"),
            new ButtonBuilder()
                .setCustomId(`team_investigate_cancel_${sessionId}`)
                .setLabel("Zesp√≥≈Ç siƒô wycofuje")
                .setStyle(ButtonStyle.Secondary)
                .setEmoji("üèÉ")
        );
    }

    createTeamAreaSelectionEmbed(location, teamSession) {
        const searchedAreas = teamSession.investigationData.areasSearched || [];
        const availableAreas = location.searchAreas.filter(
            (area) => !searchedAreas.includes(area)
        );

        return new EmbedBuilder()
            .setTitle("üîç Zesp√≥≈Ç wybiera obszar do przeszukania")
            .setDescription(
                `Zesp√≥≈Ç jest w: **${location.name}**\n\n` +
                `Przeszukane obszary: ${
                    searchedAreas.length > 0 ? searchedAreas.join(", ") : "Brak"
                }\n` +
                `Dostƒôpne obszary: ${availableAreas.length}\n\n` +
                `**Gdzie zesp√≥≈Ç chce szukaƒá?**`
            )
            .setColor("#3498db");
    }

    createTeamAreaButtons(location, teamSession, sessionId) {
        const emojis = ["üè†", "üö™", "ü™ë", "üõèÔ∏è", "üìö", "üîç", "üóÉÔ∏è", "üöΩ", "ü™ú"];
        const searchedAreas = teamSession.investigationData.areasSearched || [];
        const availableAreas = location.searchAreas.filter(
            (area) => !searchedAreas.includes(area)
        );

        const areaButtons = availableAreas.slice(0, 9).map((area, index) =>
            new ButtonBuilder()
                .setCustomId(`team_area_${sessionId}_${index}`)
                .setLabel(area.charAt(0).toUpperCase() + area.slice(1))
                .setStyle(ButtonStyle.Secondary)
                .setEmoji(emojis[index] || "üîç")
        );

        const areaRows = [];
        for (let i = 0; i < areaButtons.length; i += 3) {
            areaRows.push(
                new ActionRowBuilder().addComponents(areaButtons.slice(i, i + 3))
            );
        }

        return areaRows;
    }

    createTeamSearchingEmbed(selectedArea, location, teamSession) {
        const teamSize = teamSession.participants.length;

        return new EmbedBuilder()
            .setTitle("üîç Zesp√≥≈Ç przeszukuje lokacjƒô...")
            .setDescription(
                `Zesp√≥≈Ç ${teamSize} os√≥b ostro≈ºnie bada **${selectedArea}** w lokacji **${location.name}**...\n\n` +
                `*Wszyscy nas≈ÇuchujƒÖ ka≈ºdego d≈∫wiƒôku i obserwujƒÖ otoczenie...*\n` +
                `*Wsp√≥≈Çpraca zwiƒôksza szanse na znalezienie czego≈õ warto≈õciowego...*`
            )
            .setColor("#95a5a6")
            .setTimestamp();
    }

    async processTeamInvestigation(
        teamSession,
        location,
        selectedArea,
        initiatorId
    ) {
        const teamSize = teamSession.participants.length;
        const teamLevel = this.calculateTeamLevel(teamSession.participants);

        const teamBonus = this.calculateTeamBonus(teamSize);
        const enhancedMultiplier = location.baseMultiplier * (1 + teamBonus);

        const teamFinds = [];
        let totalRewards = {money: 0, items: [], experience: 0};
        let totalSanityChange = 0;

        for (let i = 0; i < teamSize; i++) {
            const find = this.findManager.getRandomFind(
                enhancedMultiplier,
                teamLevel
            );
            let result = this.findManager.processFind(find, selectedArea, location, {
                level: teamLevel,
                inventory: new Map(),
            });

            const teamEquipmentBonuses = this.calculateTeamEquipmentBonuses(
                teamSession.participants
            );
            result = this.equipmentManager.applyEquipmentBonuses(
                result,
                teamEquipmentBonuses
            );

            teamFinds.push({
                ...result,
                foundBy:
                    i === 0
                        ? initiatorId
                        : teamSession.participants[i]?.userId || initiatorId,
            });

            totalRewards.money += result.rewards.money;
            totalRewards.experience += result.rewards.experience;
            totalRewards.items.push(...result.rewards.items);
            totalSanityChange += result.sanityChange;
        }

        totalRewards.money = Math.floor(totalRewards.money * (1 + teamBonus));
        totalRewards.experience = Math.floor(
            totalRewards.experience * (1 + teamBonus)
        );

        totalSanityChange = Math.floor(totalSanityChange * 0.7);

        teamSession.investigationData.sharedFinds.push(...teamFinds);
        teamSession.investigationData.totalEarnings += totalRewards.money;
        teamSession.investigationData.totalExperience += totalRewards.experience;
        teamSession.investigationData.areasSearched.push(selectedArea);
        teamSession.investigationData.lastInvestigate = new Date();

        await teamSession.save();

        await this.distributeTeamRewards(
            teamSession,
            totalRewards,
            totalSanityChange
        );

        return {
            teamFinds,
            totalRewards,
            totalSanityChange,
            teamBonus,
            selectedArea,
            location,
        };
    }

    calculateTeamLevel(participants) {
        const totalExperience = participants.reduce(
            (sum, p) => sum + (p.experience || 0),
            0
        );
        const averageExperience = totalExperience / participants.length;
        return Math.floor(averageExperience / 100) + 1;
    }

    calculateTeamBonus(teamSize) {
        const bonuses = {
            2: 0.25,
            3: 0.4,
            4: 0.55,
            5: 0.65,
        };
        return bonuses[Math.min(teamSize, 5)] || bonuses[5];
    }

    calculateTeamEquipmentBonuses(participants) {
        const allEquipment = new Map();

        participants.forEach((participant) => {
            if (participant.inventory && participant.inventory instanceof Map) {
                for (const [item, quantity] of participant.inventory) {
                    const currentQuantity = allEquipment.get(item) || 0;
                    allEquipment.set(item, currentQuantity + quantity);
                }
            }
        });

        return this.equipmentManager.calculateEquipmentBonuses(
            Array.from(allEquipment.keys())
        );
    }

    async distributeTeamRewards(teamSession, totalRewards, totalSanityChange) {
        const participants = teamSession.participants;
        const rewardsPerMember = {
            money: Math.floor(totalRewards.money / participants.length),
            experience: Math.floor(totalRewards.experience / participants.length),
            sanityChange: Math.floor(totalSanityChange / participants.length),
        };

        const itemDistribution = new Map();
        totalRewards.items.forEach((item) => {
            const randomMember =
                participants[Math.floor(Math.random() * participants.length)];
            const memberItems = itemDistribution.get(randomMember.userId) || [];
            memberItems.push(item);
            itemDistribution.set(randomMember.userId, memberItems);
        });

        return {
            rewardsPerMember,
            itemDistribution,
        };
    }

    createTeamResultsEmbed(result, teamSession) {
        const {
            teamFinds,
            totalRewards,
            totalSanityChange,
            teamBonus,
            selectedArea,
            location,
        } = result;
        const teamSize = teamSession.participants.length;

        const embed = new EmbedBuilder()
            .setTitle(`üîç Zako≈Ñczono zespo≈Çowy zwiad!`)
            .setDescription(
                `Zesp√≥≈Ç ${teamSize} os√≥b przeszuka≈Ç **${selectedArea}** w lokacji **${location.name}**\n\n` +
                `*Wsp√≥≈Çpraca przynios≈Ça lepsze rezultaty ni≈º samotne dzia≈Çanie!*`
            )
            .setColor("#27ae60")
            .addFields([
                {
                    name: "üìç Szczeg√≥≈Çy",
                    value:
                        `${location.emoji} **Lokacja:** ${location.name}\n` +
                        `üîç **Obszar:** ${selectedArea}\n` +
                        `üë• **Wielko≈õƒá zespo≈Çu:** ${teamSize} cz≈Çonk√≥w\n` +
                        `ü§ù **Bonus zespo≈Çowy:** +${Math.floor(teamBonus * 100)}%`,
                    inline: false,
                },
                {
                    name: "üí∞ Nagrody zespo≈Çowe",
                    value:
                        `üíµ **Ca≈Çkowite zarobki:** $${totalRewards.money}\n` +
                        `üéØ **Ca≈Çkowite do≈õwiadczenie:** +${totalRewards.experience} XP\n` +
                        `üß† **Zmiana poczytalno≈õci:** ${
                            totalSanityChange > 0 ? "+" : ""
                        }${totalSanityChange}%\n` +
                        `üéí **Znalezione przedmioty:** ${totalRewards.items.length}`,
                    inline: false,
                },
            ])
            .setTimestamp();

        if (teamFinds.length > 0) {
            const findsText = teamFinds
                .slice(0, 5)
                .map((find, index) => {
                    return `${find.find.emoji} **${find.find.name}** (znalaz≈Ç: <@${find.foundBy}>)`;
                })
                .join("\n");

            embed.addFields([
                {
                    name: "üéí Znaleziska zespo≈Çu",
                    value:
                        findsText +
                        (teamFinds.length > 5
                            ? `\n*...i ${teamFinds.length - 5} wiƒôcej*`
                            : ""),
                    inline: false,
                },
            ]);
        }

        const searchedAreas = teamSession.investigationData.areasSearched || [];
        if (searchedAreas.length > 0) {
            embed.addFields([
                {
                    name: "üó∫Ô∏è Przeszukane obszary",
                    value: searchedAreas.join(", "),
                    inline: false,
                },
            ]);
        }

        return embed;
    }

    createTeamCancelEmbed() {
        return new EmbedBuilder()
            .setTitle("üèÉ Zesp√≥≈Ç siƒô wycofuje")
            .setDescription(
                "Zesp√≥≈Ç rozsƒÖdnie zdecydowa≈Ç siƒô wycofaƒá. Czasami lepiej byƒá ostro≈ºnym, " +
                "zw≈Çaszcza gdy odpowiadasz za bezpiecze≈Ñstwo ca≈Çego zespo≈Çu."
            )
            .setColor("#95a5a6");
    }

    createTeamEnterEmbed(location, teamSession) {
        const teamSize = teamSession.participants.length;

        return new EmbedBuilder()
            .setTitle(`${location.emoji} Zesp√≥≈Ç wchodzi do lokacji...`)
            .setDescription(
                `Zesp√≥≈Ç ${teamSize} os√≥b przekracza pr√≥g i rozglƒÖda siƒô po ciemnym wnƒôtrzu...\n\n` +
                `*Razem czujecie siƒô bezpieczniej, ale niebezpiecze≈Ñstwo nadal czai siƒô w ciemno≈õci...*`
            )
            .setColor("#34495e");
    }

    createTeamActionButtons(sessionId, location, teamSession) {
        const searchedAreas = teamSession.investigationData.areasSearched || [];
        const hasAvailableAreas = location.searchAreas.some(
            (area) => !searchedAreas.includes(area)
        );

        const buttons = [];

        if (hasAvailableAreas) {
            buttons.push(
                new ButtonBuilder()
                    .setCustomId(`team_investigate_search_${sessionId}`)
                    .setLabel("Przeszukaj obszar")
                    .setStyle(ButtonStyle.Primary)
                    .setEmoji("üîç")
            );
        }

        buttons.push(
            new ButtonBuilder()
                .setCustomId(`team_investigate_status_${sessionId}`)
                .setLabel("Status zespo≈Çu")
                .setStyle(ButtonStyle.Secondary)
                .setEmoji("üìä"),
            new ButtonBuilder()
                .setCustomId(`team_investigate_findings_${sessionId}`)
                .setLabel("Znaleziska")
                .setStyle(ButtonStyle.Secondary)
                .setEmoji("üéí"),
            new ButtonBuilder()
                .setCustomId(`team_investigate_leave_${sessionId}`)
                .setLabel("Opu≈õƒá lokacjƒô")
                .setStyle(ButtonStyle.Danger)
                .setEmoji("üö™")
        );

        const rows = [];
        for (let i = 0; i < buttons.length; i += 3) {
            rows.push(new ActionRowBuilder().addComponents(buttons.slice(i, i + 3)));
        }

        return rows;
    }

    createTeamStatusEmbed(teamSession, location) {
        const participants = teamSession.participants;
        const searchedAreas = teamSession.investigationData.areasSearched || [];
        const totalFinds = teamSession.investigationData.sharedFinds.length;

        const participantsText = participants
            .map((p) => {
                const status = p.status === "active" ? "üü¢" : "üî¥";
                return `${status} <@${p.userId}>`;
            })
            .join("\n");

        return new EmbedBuilder()
            .setTitle("üìä Status zespo≈Çu")
            .setDescription(`Zespo≈Çowe ≈õledztwo w lokacji: **${location.name}**`)
            .addFields([
                {
                    name: "üë• Cz≈Çonkowie zespo≈Çu",
                    value: participantsText,
                    inline: true,
                },
                {
                    name: "üîç Postƒôp",
                    value:
                        `Przeszukane obszary: ${searchedAreas.length}/${location.searchAreas.length}\n` +
                        `Znaleziska: ${totalFinds}\n` +
                        `Zarobki: $${teamSession.investigationData.totalEarnings}\n` +
                        `Do≈õwiadczenie: ${teamSession.investigationData.totalExperience} XP`,
                    inline: true,
                },
            ])
            .setColor("#3498db")
            .setTimestamp();
    }

    createTeamFindingsEmbed(teamSession) {
        const finds = teamSession.investigationData.sharedFinds || [];

        if (finds.length === 0) {
            return new EmbedBuilder()
                .setTitle("üéí Znaleziska zespo≈Çu")
                .setDescription("Zesp√≥≈Ç jeszcze nic nie znalaz≈Ç.")
                .setColor("#95a5a6");
        }

        const findsList = finds
            .slice(0, 10)
            .map((find, index) => {
                return (
                    `${index + 1}. ${find.find?.emoji || "üîç"} **${
                        find.find?.name || "Nieznane znalezisko"
                    }** ` + `(${find.area}) - znalaz≈Ç: <@${find.foundBy}>`
                );
            })
            .join("\n");

        return new EmbedBuilder()
            .setTitle("üéí Znaleziska zespo≈Çu")
            .setDescription(
                findsList +
                (finds.length > 10 ? `\n*...i ${finds.length - 10} wiƒôcej*` : "")
            )
            .addFields([
                {
                    name: "üìä Podsumowanie",
                    value:
                        `üéí Ca≈Çkowite znaleziska: ${finds.length}\n` +
                        `üí∞ Ca≈Çkowite zarobki: $${teamSession.investigationData.totalEarnings}\n` +
                        `üéØ Ca≈Çkowite do≈õwiadczenie: ${teamSession.investigationData.totalExperience} XP`,
                    inline: false,
                },
            ])
            .setColor("#27ae60")
            .setTimestamp();
    }
}

module.exports = CooperativeInvestigation;
